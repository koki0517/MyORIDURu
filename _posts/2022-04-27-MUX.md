---
layout: post
title: Syntax Highlighting Post
date: 2013-08-16
excerpt: "Demo post displaying the various ways of highlighting code in Markdown."
tags: []
---

# EV3 Sensor Multiplexer

## はじめに
EV3で遊んでいると誰もが**ポート数の壁**に当たるでしょう。<br>
それを解決する手段はいくつか有り、EV3本体を2つ接続するデイジーチェーンはその代表的なものです。ですが、デイジーチェーンには**ロボットが重くなってしまう**というデメリットがあります。現に私も某ロボット大会でそれを思い知らされました。 <br>そこで使ったのが[EV3 Sensor Multiplexer](http://www.mindsensors.com/ev3-and-nxt/23-ev3-sensor-multiplexer-for-ev3-or-nxt)です。(以下MUX)↓

<img width="250" alt="ev3-sensor-multiplexer-for-ev3-or-nxt.jpg" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2449798/66228ee7-5aff-d1c5-d6c6-90cd7a1e6a84.jpeg">

4つのポートの内1つはEV3との接続用で残り3つはセンサーを接続できます。※<font color="LightCoral">LEGO純正センサーのみ接続可</font><br>
それ以外のHiTechnic社製, mindsensors.com社製のセンサーなら、[リンク先](http://docs.ev3dev.org/projects/lego-linux-drivers/en/ev3dev-stretch/muxs.html#supported-multiplexers)の表のものが使えます。  <br>
*MUXについて日本語の解説が見つけられなかったので自分で書いてみます。*<br>
※Python3と[ev3dev-python](https://ev3dev-lang.readthedocs.io/projects/python-ev3dev/en/stable/)についてある程度の知識がある前提での記事です。  <br>
　[この方の記事](https://qiita.com/masterkeaton12/items/938457911b0f3f25e161)をもとに環境構築をしておいてください。<br>


## 環境
* [この記事](https://qiita.com/masterkeaton12/items/938457911b0f3f25e161)の内容を終えている<br>
* Windows10<br>
* VScode<br>

## アドレス
MUXの接続には**I2C**接続を使います。I2Cアドレスは以下の通り。<br>
| MUXのポート | I2Cアドレス(16進法) | I2Cアドレス(10進法) |
| :-: | :-: | :-: |
| C1 | 0x50 | 80 |
| C2 | 0x51 | 81 |
| C3 | 0x52 | 82 |

プログラムでは10進法のI2Cアドレスを使います。  <br>
アドレスの基本形は`[<parent-address>:]mux<n>`  <br>
これに沿ってフルアドレス一覧を作ると...<br>

| |ポート１|ポート２|ポート３|ポート４|
|:----:|:----:|:----:|:----:|:----:|
|C１|in1:i2c80:mux1|in2:i2c80:mux1|in3:i2c80:mux1|in4:i2c80:mux1|
|C２|in1:i2c81:mux2|in2:i2c81:mux2|in3:i2c81:mux2|in4:i2c81:mux2|
|C３|in1:i2c82:mux3|in2:i2c82:mux3|in3:i2c82:mux3|in4:i2c82:mux3|

縦軸がMultiplexer、横軸がEV3のポートに対応しています。<br>  
例:MultiplexerをEV3のポート2に接続しセンサーをC3に接続した場合→`in2:i2c82:mux3`<br>  

## サンプルコード
C1ポートにタッチセンサー、<br>
C2ポートに超音波センサー、<br>
C3ポートにカラーセンサーを接続して、それぞれのセンサーの値を表示するコードです。<br>

Multiplexerを使うには1つのセンサーに対して2つのインスタインスを生成する必要があります。(5行目~6行目&14行目~16行目)<br>
・5行目~6行目で生成したインスタンスはセンサーのドライバなどの設定に使います。<br>
・14行目~16行目で生成したインスタンスはセンサーのモード変更や値の取得に使います。<br>

``` sample.py
#!/usr/bin/env python3
from time import sleep
from ev3dev.ev3 import *

# LegoPortを使ってインスタンスを生成します。
muxC1port = LegoPort("in2:i2c80:mux1") # タッチセンサー
muxC2port = LegoPort("in2:i2c82:mux3") # 超音波センサー

# モードを変更します。デフォルトでは"uart"になっていて、タッチセンサーのみ"analog"に変更する必要があります。なので、muxC2portに関しては変更していません。
muxC1port.mode = "analog"
# 各種初期化の後には一定時間スリープさせる必要があります。VScodeで実行するときには1s、SSHや本体から実行するときには0.5sの遅延が必要です。
sleep(1)

# ドライバを変更します。
muxC1port.set_device = "lego-ev3-touch"
muxC2port.set_device = "lego-ev3-us"
# ※デフォルトでは"lego-ev3-color"になっています。なので、muxC2portに関しては変更していません。

# インスタンスを生成します。
touchsensor = TouchSensor("in2:i2c80:mux1") # タッチセンサー
ultrasonicsensor = UltrasonicSensor("in2:i2c81:mux2") # 超音波センサー
colorsensor = ColorSensor("in2:i2c82:mux3") # カラーセンサー
sleep(1)

# 取得する値のモードを変更します。
ultrasonicsensor.mode = "US-DIST-CM"
colorsensor.mode = "COL-COLOR"

# 各センサーの値を表示します。
print(str(touchsensor.value(0))+"_"+str(ultrasonicsensor.value(0))+"_"+str(colorsensor.value(0)))
```

※C3ポートについてはカラーセンサーなのでモード等を変更する必要がなくLegoPortのインスタンスを生成していません

[センサーの取得する値のモードについて。](http://docs.ev3dev.org/projects/lego-linux-drivers/en/ev3dev-stretch/sensor_data.html#)

## 参考文献
[https://qiita.com/masterkeaton12/items/938457911b0f3f25e161](https://qiita.com/masterkeaton12/items/938457911b0f3f25e161)

[http://docs.ev3dev.org/projects/lego-linux-drivers/en/ev3dev-stretch/sensors.html](http://docs.ev3dev.org/projects/lego-linux-drivers/en/ev3dev-stretch/sensors.html)

[http://docs.ev3dev.org/projects/lego-linux-drivers/en/ev3dev-stretch/muxs.html](http://docs.ev3dev.org/projects/lego-linux-drivers/en/ev3dev-stretch/muxs.html)

[http://docs.ev3dev.org/projects/lego-linux-drivers/en/ev3dev-stretch/i2c.html](http://docs.ev3dev.org/projects/lego-linux-drivers/en/ev3dev-stretch/i2c.html)

[https://ofalcao.pt/blog/series/lego-laser-harp](https://ofalcao.pt/blog/series/lego-laser-harp)

[https://thebrickdane.com/2019/06/17/more-sensors-mindsensors-com-sensor-multiplexer/](https://thebrickdane.com/2019/06/17/more-sensors-mindsensors-com-sensor-multiplexer/)